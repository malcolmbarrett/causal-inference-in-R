{
  "hash": "584d03813f5ce171acb15aa61152d508",
  "result": {
    "markdown": "# Causal estimands {#sec-estimands}\n\n\n\n\n\n## Estimands, Estimators, Estimates\n\nWhen analyzing to make causal inferences, we need to keep the causal question that we're interested in close to our chest.\nThe causal question helps guide not just the assumptions we need to make but also how we will go about answering the question.\nThis chapter deals with three ideas closely related to answering causal questions: the estimand, the estimator, and the estimate.\nThe **estimand** is the *target of interest*, the **estimator** is the method by which we approximate this estimand using data, and the **estimate** is the value we get when we plug our data into the estimator.\nYou can think of the **estimand** as a glossy picture of a beautiful cake we are trying to bake, the **estimator** as the recipe, and the **estimate** as the cake we pull out of our oven.\n\nSo far, we have been estimating the average treatment effect, the effect of the exposure of interest averaged across the whole population.\nThe **estimand** here is the expected value of the difference in potential outcomes across all individuals:\n\n$$E[Y(1) - Y(0)]$$\n\nThe **estimator** we use depends on the method we've chosen.\nFor example, in an A/B test or randomized controlled trial, our estimator could just be the average outcome among those who received the exposure A minus the average outcome among those who receive exposure B.\n\n$$\\sum_{i=1}^{N}\\frac{Y_i\\times X_i}{N_{\\textrm{A}}} - \\frac{Y_i\\times (1-X_i)}{N_{\\textrm{B}}}$$\n\nWhere $X$ is just an indicator for exposure A ($X = 1$ for exposure A and $X = 0$ for exposure B), $N_A$ is the total number in group A and $N_B$ is the total number in group B such that $N_A + N_B = N$.\nLet's motivate this example a bit more.\nSuppose we have two different designs for a call-to-action (often abbreviated as CTA, a written directive for a marketing campaign) and want to assess whether they lead to a different average number of items a user purchases.\nWe can create an A/B test where we randomly assign a subset of users to see design A or design B.\nSuppose we have A/B testing data for 100 participants in a dataset called `ab`.\nHere is some code to simulate such a data set.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nset.seed(928)\nab <- tibble(\n  # generate the exposure, x, from a binomial distribution\n  # with the probability exposure A of 0.5\n  x = rbinom(100, 1, 0.5),\n  # generate the \"true\" average treatment effect of 1\n  # we use rnorm(100) to add the random error term that is normally\n  # distributed with a mean of 0 and a standard deviation of 1\n  y = x + rnorm(100)\n)\n```\n:::\n\n\nHere the exposure is `x`, and the outcome is `y`.\nThe true average treatment effect is 1, implying that on average seeing call-to-action A increases the number of items purchased by 1.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nab\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 100 × 2\n       x      y\n   <int>  <dbl>\n 1     0 -0.280\n 2     1  1.87 \n 3     1  1.36 \n 4     0 -0.208\n 5     0  1.13 \n 6     1  0.352\n 7     1 -0.148\n 8     1  2.08 \n 9     0  2.09 \n10     0 -1.41 \n# ℹ 90 more rows\n```\n\n\n:::\n:::\n\n\nBelow are two ways to estimate this in R.\nUsing a formula approach, we calculate the difference in `y` between exposure values in the first example.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nab |>\n  summarise(\n    n_a = sum(x),\n    n_b = sum(1 - x),\n    estimate = sum(\n      (y * x) / n_a -\n        y * (1 - x) / n_b\n    )\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 3\n    n_a   n_b estimate\n  <int> <dbl>    <dbl>\n1    54    46     1.15\n```\n\n\n:::\n:::\n\n\nAlternatively, we can `group_by()` `x` and `summarize()` the means of `y` for each group, then pivot the results to take their difference.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nab |>\n  group_by(x) |>\n  summarise(avg_y = mean(y)) |>\n  pivot_wider(\n    names_from = x,\n    values_from = avg_y,\n    names_prefix = \"x_\"\n  ) |>\n  summarise(estimate = x_1 - x_0)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 1\n  estimate\n     <dbl>\n1     1.15\n```\n\n\n:::\n:::\n\n\nBecause $X$, the exposure, was randomly assigned, this estimator results in an unbiased estimate of our estimand of interest.\n\nWhat do we mean by unbiased, though?\nNotice that while the \"true\" causal effect is 1, this estimate is not precisely 1; it is 1.149.\nWhy the difference?\nThis A/B test included a sample of 100 participants, not the whole population.\nAs that sample increases, our estimate will get closer to the truth.\nLet's try that.\nLet's simulate the data again but increase the sample size from 100 to 100,000:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(928)\nab <- tibble(\n  x = rbinom(100000, 1, 0.5),\n  y = x + rnorm(100000)\n)\n\nab |>\n  summarise(\n    n_a = sum(x),\n    n_b = sum(1 - x),\n    estimate = sum(\n      (y * x) / n_a -\n        y * (1 - x) / n_b\n    )\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 3\n    n_a   n_b estimate\n  <int> <dbl>    <dbl>\n1 49918 50082     1.01\n```\n\n\n:::\n:::\n\n\nNotice how the estimate is 1.01, much closer to the actual average treatment effect, 1.\n\nSuppose $X$ had not been randomly assigned.\nIn that case, we could use the pre-exposure covariates to estimate the conditional probability of $X$ (the propensity score) and incorporate this probability in a *weight* $(w_i)$ to estimate this causal effect.\nFor example, we could use the following *estimator* to *estimate* our average treatment effect *estimand*:\n\n$$\\frac{\\sum_{i=1}^NY_i\\times X_i\\times w_i}{\\sum_{i=1}^NX_i\\times w_i}-\\frac{\\sum_{i=1}^NY_i\\times(1-X_i)\\times w_i}{\\sum_{i=1}^N(1-X_i)\\times w_i}$$\n\n## Estimating treatment effects with specific targets in mind\n\nDepending on the study's goal, or the causal question, we may want to estimate different *estimands*.\nHere, we will outline the most common causal estimands, their target populations, the causal questions they may help answer, and the methods used to estimate them [@greifer2021choosing].\n\n### Average treatment effect\n\nA common estimand is the average treatment effect (ATE).\nThe target population is the *total sample* or population of interest.\nThe **estimand** here is the expected value of the difference in potential outcomes across all individuals:\n\n$$E[Y(1) - Y(0)]$$\n\nAn example research question is \"Should a policy be applied to all eligible patients?\" [@greifer2021choosing].\n\nMost randomized controlled trials are designed with the ATE as the target estimand.\nIn a non-randomized setting, you can estimate the ATE using full matching.\nEach observation in the exposed group is matched to at least one observation in the control group (and vice versa) without replacement.\nAlternatively, the following inverse probability weight will allow you to estimate the ATE using propensity score weighting.\n\n$$w_{ATE} = \\frac{X}{p} + \\frac{(1 - X)}{1 - p}$$\n\nIn other words, the weight is one over the propensity score for those in the exposure group and one over one minus the propensity score for the control group.\nIntuitively, this weight equates to the inverse probability of being in the exposure group in which you actually were.\n\nLet's dig deeper into this causal estimand using the Touring Plans data.\nRecall that in @sec-using-ps, we examined the relationship between whether there were \"Extra Magic Hours\" in the morning and the average wait time for the Seven Dwarfs Mine Train the same day between 9 am and 10 am.\nLet's reconstruct our data set, `seven_dwarfs` and fit the same propensity score model specified previously.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(broom)\nlibrary(touringplans)\n\nseven_dwarfs <- seven_dwarfs_train_2018 |>\n  filter(wait_hour == 9) |>\n  mutate(park_extra_magic_morning = factor(\n    park_extra_magic_morning,\n    labels = c(\"No Magic Hours\", \"Extra Magic Hours\")\n  ))\n\nseven_dwarfs_with_ps <- glm(\n  park_extra_magic_morning ~ park_ticket_season + park_close + park_temperature_high,\n  data = seven_dwarfs,\n  family = binomial()\n) |>\n  augment(type.predict = \"response\", data = seven_dwarfs)\n```\n:::\n\n\nLet's examine a table of the variables of interest in this data frame.\nTo do so, we are going to use the `tbl_summary()` function from the `{gtsummary}` package.\n(We'll also use the `{labelled}` package to clean up the variable names for the table.)\n\n\n::: {#tbl-unweighted-gtsummary .cell tbl-cap='A descriptive table of Extra Magic Morning in the touringplans dataset. This table shows the distributions of these variables in the observed population.'}\n\n```{.r .cell-code}\nlibrary(gtsummary)\nlibrary(labelled)\nseven_dwarfs_with_ps <- seven_dwarfs_with_ps |>\n  set_variable_labels(\n    park_ticket_season = \"Ticket Season\",\n    park_close = \"Close Time\",\n    park_temperature_high = \"Historic High Temperature\"\n  )\n\ntbl_summary(\n  seven_dwarfs_with_ps,\n  by = park_extra_magic_morning,\n  include = c(park_ticket_season, park_close, park_temperature_high)\n) |>\n  # add an overall column to the table\n  add_overall(last = TRUE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"eugzvcxdgr\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>html {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#eugzvcxdgr .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#eugzvcxdgr .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#eugzvcxdgr .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#eugzvcxdgr .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#eugzvcxdgr .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#eugzvcxdgr .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#eugzvcxdgr .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#eugzvcxdgr .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#eugzvcxdgr .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#eugzvcxdgr .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#eugzvcxdgr .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#eugzvcxdgr .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#eugzvcxdgr .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#eugzvcxdgr .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#eugzvcxdgr .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#eugzvcxdgr .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#eugzvcxdgr .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#eugzvcxdgr .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#eugzvcxdgr .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#eugzvcxdgr .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#eugzvcxdgr .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#eugzvcxdgr .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#eugzvcxdgr .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#eugzvcxdgr .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#eugzvcxdgr .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#eugzvcxdgr .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#eugzvcxdgr .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#eugzvcxdgr .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#eugzvcxdgr .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#eugzvcxdgr .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-left: 4px;\n  padding-right: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#eugzvcxdgr .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#eugzvcxdgr .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#eugzvcxdgr .gt_left {\n  text-align: left;\n}\n\n#eugzvcxdgr .gt_center {\n  text-align: center;\n}\n\n#eugzvcxdgr .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#eugzvcxdgr .gt_font_normal {\n  font-weight: normal;\n}\n\n#eugzvcxdgr .gt_font_bold {\n  font-weight: bold;\n}\n\n#eugzvcxdgr .gt_font_italic {\n  font-style: italic;\n}\n\n#eugzvcxdgr .gt_super {\n  font-size: 65%;\n}\n\n#eugzvcxdgr .gt_footnote_marks {\n  font-style: italic;\n  font-weight: normal;\n  font-size: 75%;\n  vertical-align: 0.4em;\n}\n\n#eugzvcxdgr .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#eugzvcxdgr .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#eugzvcxdgr .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#eugzvcxdgr .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#eugzvcxdgr .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#eugzvcxdgr .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\">\n  \n  <thead class=\"gt_col_headings\">\n    <tr>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Characteristic&lt;/strong&gt;\"><strong>Characteristic</strong></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;No Magic Hours&lt;/strong&gt;, N = 294&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>No Magic Hours</strong>, N = 294<sup class=\"gt_footnote_marks\">1</sup></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Extra Magic Hours&lt;/strong&gt;, N = 60&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>Extra Magic Hours</strong>, N = 60<sup class=\"gt_footnote_marks\">1</sup></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Overall&lt;/strong&gt;, N = 354&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>Overall</strong>, N = 354<sup class=\"gt_footnote_marks\">1</sup></th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Ticket Season</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\"></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    peak</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">60 (20%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">18 (30%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">78 (22%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    regular</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">158 (54%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">35 (58%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">193 (55%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    value</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">76 (26%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">7 (12%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">83 (23%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Close Time</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\"></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    16:30:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">1 (0.3%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">0 (0%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">1 (0.3%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    18:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">37 (13%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">18 (30%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">55 (16%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    20:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">18 (6.1%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">2 (3.3%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">20 (5.6%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    21:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">28 (9.5%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">0 (0%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">28 (7.9%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    22:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">91 (31%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">11 (18%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">102 (29%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    23:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">78 (27%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">11 (18%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">89 (25%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    24:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">40 (14%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">17 (28%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">57 (16%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    25:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">1 (0.3%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">1 (1.7%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">2 (0.6%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Historic High Temperature</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">84 (78, 89)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">83 (76, 87)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">84 (78, 89)</td></tr>\n  </tbody>\n  \n  <tfoot class=\"gt_footnotes\">\n    <tr>\n      <td class=\"gt_footnote\" colspan=\"4\"><sup class=\"gt_footnote_marks\">1</sup> n (%); Median (IQR)</td>\n    </tr>\n  </tfoot>\n</table>\n</div>\n```\n\n:::\n:::\n\n\nFrom @tbl-unweighted-gtsummary, 294 days did not have extra magic hours in the morning, and 60 did.\nWe also see that 30% of the extra magic mornings were during peak season compared to 20% of the non-extra magic mornings.\nAdditionally, days with extra magic mornings were more likely to close at 6 pm (18:00:00) compared to non-magic hour mornings.\nThe median high temperature on days with extra magic hour mornings is slightly lower (83 degrees) compared to non-extra magic hour morning days.\n\nNow let's construct our propensity score weight to estimate the ATE.\nThe `{propensity}` package has helper functions to estimate weights.\nThe `wt_ate()` function will calculate ATE weights.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(propensity)\nseven_dwarfs_wts <- seven_dwarfs_with_ps |>\n  mutate(w_ate = wt_ate(.fitted, park_extra_magic_morning))\n```\n:::\n\n\nLet's look at a distribution of these weights.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(seven_dwarfs_wts, aes(x = w_ate)) +\n  geom_histogram(bins = 50)\n```\n\n::: {.cell-output-display}\n![A histogram of the average treatment effect (ATE) weights for whether or not a day had extra magic hours. ATE weights can range from 1 to infinity, so paying attention to the actual range of weights is important.](chapter-10_files/figure-html/fig-sd-ate-hist-1.png){#fig-sd-ate-hist width=672}\n:::\n:::\n\n\nMany weights in @fig-sd-ate-hist are close to 1 (the smallest possible value for an ATE weight), with a long tail leading to the largest weight (around 24).\nThis distribution highlights a potential problem with ATE weights.\nThey range from 1 to infinity; if your weights are too large in small samples, this can lead to bias in your estimates (known as finite sample bias).\n\n::: {.callout-warning}\n## Finite sample bias\n\nWe know that not accounting for confounders can bias our causal estimates, but it turns out that even after accounting for all confounders, we may still get a biased estimate in finite samples.\nMany of the properties we tout in statistics rely on *large samples*---how \"large\" is defined can be opaque.\nLet's look at a quick simulation.\nHere, we have an exposure, $X$, an outcome, $Y$, and one confounder, $Z$.\nWe will simulate $Y$, which is only dependent on $Z$ (so the true treatment effect is 0), and $X$, which also depends on $Z$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(928)\nn <- 100\nfinite_sample <- tibble(\n  # z is normally distributed with a mean: 0 and sd: 1\n  z = rnorm(n),\n  # x is defined from a probit selection model with normally distributed errors\n  x = case_when(\n    0.5 + z + rnorm(n) > 0 ~ 1,\n    TRUE ~ 0\n  ),\n  # y is continuous, dependent only on z with normally distrbuted errors\n  y = z + rnorm(n)\n)\n```\n:::\n\n\nIf we fit a propensity score model using the one confounder $Z$ and calculate the weighted estimator, we should get an unbiased result (which in this case would be 0).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## fit the propensity score model\nfinite_sample_wts <- glm(\n  x ~ z, data = finite_sample, family = binomial(\"probit\")) |>\n  augment(newdata = finite_sample, type.predict = \"response\") |>\n  mutate(wts = wt_ate(.fitted, x))\n\nfinite_sample_wts |>\n  summarize(\n    effect = sum(y * x * wts) / sum(x * wts) - \n      sum(y * (1 - x) * wts) / sum((1 - x) * wts)\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 1\n  effect\n   <dbl>\n1  0.197\n```\n\n\n:::\n:::\n\n\nOk, here, our effect of $X$ is pretty far from 0, although it's hard to know if this is really bias, or something we are just seeing by chance in this particular simulated sample.\nTo explore the potential for finite sample bias, we can rerun this simulation many times at different sample sizes.\nLet's do that.\n\n\n::: {.cell hash='chapter-10_cache/html/sim-finite-sample-bias_917f43210915e4732926d02a7bd88116'}\n\n```{.r .cell-code}\nsim <- function(n) {\n  ## create a simulated dataset\n  finite_sample <- tibble(\n    z = rnorm(n),\n    x = case_when(\n      0.5 + z + rnorm(n) > 0 ~ 1,\n      TRUE ~ 0\n    ),\n    y = z + rnorm(n)\n  )\n  finite_sample_wts <- glm(\n    x ~ z, data = finite_sample, family = binomial(\"probit\")) |>\n    augment(newdata = finite_sample, type.predict = \"response\") |>\n    mutate(wts = wt_ate(.fitted, x))\n  bias <- finite_sample_wts |>\n    summarize(\n      effect = sum(y * x * wts) / sum(x * wts) - \n        sum(y * (1 - x) * wts) / sum((1 - x) * wts)\n    ) |> \n    pull()\n  tibble(\n    n = n,\n    bias = bias\n  )\n}\n\n## Examine 5 different sample sizes, simulate each 1000 times\nset.seed(1)\nfinite_sample_sims <- map_df(rep(c(50, 100, 500, 1000, 5000, 10000),\n                                 each = 1000), sim)\n\nbias <- finite_sample_sims %>%\n  group_by(n) %>%\n  summarise(bias = mean(bias))\n```\n:::\n\n\nLet's plot our results:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(bias, aes(x = n, y = bias)) +\n  geom_point() + \n  geom_line() + \n  geom_hline(yintercept = 0, lty = 2)\n```\n\n::: {.cell-output-display}\n![Finite sample bias present with ATE weights created using correctly specified propensity score model, varying the sample size from n = 50 to n = 10,000](chapter-10_files/figure-html/fig-finite-sample-bias-1.png){#fig-finite-sample-bias width=672}\n:::\n:::\n\n\nThis is an example of finite sample bias.\nNotice here, even when the sample size is quite large (5,000) we still see some bias away from the \"true\" effect of 0.\nIt isn't until a sample size larger than 10,000 that we see this bias disappear.\n\nEstimands that utilize weights that are unbounded (i.e. that theoretically can be infinitely large) are more likely to suffer from finite sample bias.\nThe likelihood of falling into finite sample bias depends on:\\\n(1) the estimand you have chosen (i.e. are the weights bounded?)\\\n(2) the distribution of the covariates in the exposed and unexposed groups (i.e. is there good overlap? Potential positivity violations, when there is poor overlap, are the regions where weights can become too large)\\\n(3) the sample size.\n:::\n\nThe `{gtsummary}` package allows the creation of *weighted* tables, which can help us build an intuition for the psuedopopulation created by the weights.\nFirst, we must load the `{survey}` package and create a survey design object.\nThe `{survey}` package supports calculating statistics and models using weights.\nHistorically, many researchers applied techniques incorporating weights to survey analyses.\nEven though we are not doing a survey analysis, the same techniques are helpful for our propensity score weights.\n\n\n::: {#tbl-weighted-gtsummary .cell tbl-cap='A descriptive table of Extra Magic Morning hours weighted by the Average Treatment Effect Weights. This table shows the distributions of these variables in the psuedopopulation created by these weights.'}\n\n```{.r .cell-code}\nlibrary(survey)\nseven_dwarfs_svy <- svydesign(\n  ids = ~1,\n  data = seven_dwarfs_wts,\n  weights = ~w_ate\n)\ntbl_svysummary(\n  seven_dwarfs_svy,\n  by = park_extra_magic_morning,\n  include = c(park_ticket_season, park_close, park_temperature_high)\n) |>\n  add_overall(last = TRUE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"uaaskkmbew\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>html {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#uaaskkmbew .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#uaaskkmbew .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#uaaskkmbew .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#uaaskkmbew .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#uaaskkmbew .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#uaaskkmbew .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#uaaskkmbew .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#uaaskkmbew .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#uaaskkmbew .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#uaaskkmbew .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#uaaskkmbew .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#uaaskkmbew .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#uaaskkmbew .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#uaaskkmbew .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#uaaskkmbew .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#uaaskkmbew .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#uaaskkmbew .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#uaaskkmbew .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#uaaskkmbew .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#uaaskkmbew .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#uaaskkmbew .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-left: 4px;\n  padding-right: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#uaaskkmbew .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#uaaskkmbew .gt_left {\n  text-align: left;\n}\n\n#uaaskkmbew .gt_center {\n  text-align: center;\n}\n\n#uaaskkmbew .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#uaaskkmbew .gt_font_normal {\n  font-weight: normal;\n}\n\n#uaaskkmbew .gt_font_bold {\n  font-weight: bold;\n}\n\n#uaaskkmbew .gt_font_italic {\n  font-style: italic;\n}\n\n#uaaskkmbew .gt_super {\n  font-size: 65%;\n}\n\n#uaaskkmbew .gt_footnote_marks {\n  font-style: italic;\n  font-weight: normal;\n  font-size: 75%;\n  vertical-align: 0.4em;\n}\n\n#uaaskkmbew .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#uaaskkmbew .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#uaaskkmbew .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#uaaskkmbew .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#uaaskkmbew .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#uaaskkmbew .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\">\n  \n  <thead class=\"gt_col_headings\">\n    <tr>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Characteristic&lt;/strong&gt;\"><strong>Characteristic</strong></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;No Magic Hours&lt;/strong&gt;, N = 354&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>No Magic Hours</strong>, N = 354<sup class=\"gt_footnote_marks\">1</sup></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Extra Magic Hours&lt;/strong&gt;, N = 357&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>Extra Magic Hours</strong>, N = 357<sup class=\"gt_footnote_marks\">1</sup></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Overall&lt;/strong&gt;, N = 711&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>Overall</strong>, N = 711<sup class=\"gt_footnote_marks\">1</sup></th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Ticket Season</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\"></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    peak</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">78 (22%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">81 (23%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">160 (22%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    regular</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">193 (54%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">187 (52%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">380 (53%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    value</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">83 (23%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">89 (25%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">172 (24%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Close Time</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\"></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    16:30:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">2 (0.4%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">0 (0%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">2 (0.2%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    18:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">50 (14%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">72 (20%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">122 (17%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    20:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">20 (5.6%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">19 (5.3%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">39 (5.5%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    21:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">31 (8.7%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">0 (0%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">31 (4.3%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    22:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">108 (30%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">86 (24%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">193 (27%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    23:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">95 (27%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">81 (23%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">176 (25%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    24:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">48 (14%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">94 (26%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">142 (20%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    25:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">1 (0.3%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">6 (1.6%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">7 (1.0%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Historic High Temperature</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">84 (78, 89)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">83 (78, 87)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">84 (78, 88)</td></tr>\n  </tbody>\n  \n  <tfoot class=\"gt_footnotes\">\n    <tr>\n      <td class=\"gt_footnote\" colspan=\"4\"><sup class=\"gt_footnote_marks\">1</sup> n (%); Median (IQR)</td>\n    </tr>\n  </tfoot>\n</table>\n</div>\n```\n\n:::\n:::\n\n\nNotice in @tbl-weighted-gtsummary that the variables are more **balanced** between the groups.\nFor example, looking at the variable `park_ticket_season`, in @tbl-unweighted-gtsummary we see that a higher percentage of the days with extra magic hours in the mornings were during the peak season (30%) compared to the percent of days without extra magic hours in the morning (23%).\nIn @tbl-weighted-gtsummary this is balanced, with a weighted percent of 22% peak days in the extra magic morning group and 22% in the no extra magic morning group.\nThe weights change the variables' distribution by weighting each observation so that the two groups appear balanced.\nAlso, notice that the distribution of variables in @tbl-weighted-gtsummary now matches the Overall column of @tbl-unweighted-gtsummary.\nThat is what ATE weights do: they make the distribution of variables included in the propensity score for each exposure group look like the overall distribution across the whole sample.\n\nLet's look at another visualization that can help us understand the weighted psuedopopulation created by the ATE weights: a mirrored histogram.\nWe will plot the distribution of the propensity score for the days in the exposure group (days with extra magic hours in the morning) on the top half of the plot; then, we will mirror the distribution of the propensity score for the days in the\"unexposed group below it. This visualization allows us to compare the two distributions quickly. Then we will overlay weighted histograms to demonstrate how these distributions differ after incorporating the weights. The {halfmoon} package includes a function `geom_mirror_histogram()` to assist with this visualization.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(halfmoon)\nggplot(seven_dwarfs_wts, aes(.fitted, group = park_extra_magic_morning)) +\n  geom_mirror_histogram(bins = 50) +\n  geom_mirror_histogram(\n    aes(fill = park_extra_magic_morning, weight = w_ate),\n    bins = 50,\n    alpha = 0.5\n  ) +\n  scale_y_continuous(labels = abs) +\n  labs(\n    x = \"propensity score\",\n    fill = \"Extra Magic Morning\"\n  )\n```\n\n::: {.cell-output-display}\n![A mirrored histogram of the distribution of propensity scores between exposure groups. The dark bars represent the unweighted distribution, and the colored bars represent the distribution weighted by the average treatment effect (ATE) weight.](chapter-10_files/figure-html/fig-sd-mirror-hist-ate-1.png){#fig-sd-mirror-hist-ate width=672}\n:::\n:::\n\n\nWe can learn a few things from @fig-sd-mirror-hist-ate.\nFirst, we can see that there are more \"unexposed\" days---days without extra magic hours in the morning---compared to \"exposed\" in the observed population.\nWe can see this by examining the darker histograms, which show the distributions in the observed sample.\nSimilarly, the exposed days are upweighted more substantially, as evidenced by the light blue we see on the top.\nWe can also see that after weighting, the two distributions look similar; the shape of the blue weighted distribution on top looks comparable to the orange weighted distribution below.\n\n### Average treatment effect among the treated\n\nThe target population to estimate the average treatment effect among the treated (ATT) is the *exposed* (treated) population.\nThis causal estimand conditions on those in the exposed group:\n\n$$E[Y(1) - Y(0) | X = 1]$$\n\nExample research questions where the ATT is of interest could include \"Should we stop our marketing campaign to those currently receiving it?\" or \"Should medical providers stop recommending treatment for those currently receiving it?\" [@greifer2021choosing]\n\nThe ATT is a common target estimand when using matching; here, all exposed observations are included and \"matched\" to control observations, some of which may be discarded.\nAlternatively, the ATT can be estimated via weighting.\nThe ATT weight is estimated by:\n\n$$w_{ATT} = X + \\frac{(1 - X)p}{1 - p}$$\n\nLet's add the ATT weights to the `seven_dwarfs_wts` data frame and look at their distribution.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseven_dwarfs_wts <- seven_dwarfs_wts |>\n  mutate(w_att = wt_att(.fitted, park_extra_magic_morning))\n\nggplot(seven_dwarfs_wts, aes(w_att)) +\n  geom_histogram(bins = 50)\n```\n\n::: {.cell-output-display}\n![A histogram of the average treatment effect among the treated (ATT) weights. The range of the ATT weights in this example is more stable than the ATE weights: the range is much smaller.](chapter-10_files/figure-html/fig-sd-att-hist-1.png){#fig-sd-att-hist width=672}\n:::\n:::\n\n\nCompared to the ATE weights, the weights in @fig-sd-att-hist look more *stable*; the distribution of the weights is not heavily skewed, and the range is small, from ground zero to a bit over one, with many at precisely one.\nThese weights are exactly one for all days in the exposed group.\nTheoretically, for unexposed days these weights can range from zero to infinity.\nStill, because we have many more unexposed days compared to exposed in this particular sample, the range is much smaller, meaning the vast majority of unexposed days are \"down-weighted\" to match the variable distribution of the exposed days.\nLet's take a look at the weighted table to see this a bit more clearly.\n\n\n::: {#tbl-weighted-att .cell tbl-cap='A descriptive table of Extra Magic Morning hours weighted by the Average Treatment Effect among the Treated Weights. This table shows the distributions of these variables in the psuedopopulation created by these weights.'}\n\n```{.r .cell-code}\nseven_dwarfs_svy <- svydesign(\n  ids = ~1,\n  data = seven_dwarfs_wts,\n  weights = ~w_att\n)\ntbl_svysummary(\n  seven_dwarfs_svy,\n  by = park_extra_magic_morning,\n  include = c(park_ticket_season, park_close, park_temperature_high)\n) |>\n  add_overall(last = TRUE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"kyuiqrqycx\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>html {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#kyuiqrqycx .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#kyuiqrqycx .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#kyuiqrqycx .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#kyuiqrqycx .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#kyuiqrqycx .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#kyuiqrqycx .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#kyuiqrqycx .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#kyuiqrqycx .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#kyuiqrqycx .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#kyuiqrqycx .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#kyuiqrqycx .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#kyuiqrqycx .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#kyuiqrqycx .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#kyuiqrqycx .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#kyuiqrqycx .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#kyuiqrqycx .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#kyuiqrqycx .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#kyuiqrqycx .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kyuiqrqycx .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#kyuiqrqycx .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#kyuiqrqycx .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kyuiqrqycx .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#kyuiqrqycx .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#kyuiqrqycx .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#kyuiqrqycx .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kyuiqrqycx .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#kyuiqrqycx .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#kyuiqrqycx .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#kyuiqrqycx .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#kyuiqrqycx .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-left: 4px;\n  padding-right: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kyuiqrqycx .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#kyuiqrqycx .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kyuiqrqycx .gt_left {\n  text-align: left;\n}\n\n#kyuiqrqycx .gt_center {\n  text-align: center;\n}\n\n#kyuiqrqycx .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#kyuiqrqycx .gt_font_normal {\n  font-weight: normal;\n}\n\n#kyuiqrqycx .gt_font_bold {\n  font-weight: bold;\n}\n\n#kyuiqrqycx .gt_font_italic {\n  font-style: italic;\n}\n\n#kyuiqrqycx .gt_super {\n  font-size: 65%;\n}\n\n#kyuiqrqycx .gt_footnote_marks {\n  font-style: italic;\n  font-weight: normal;\n  font-size: 75%;\n  vertical-align: 0.4em;\n}\n\n#kyuiqrqycx .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#kyuiqrqycx .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#kyuiqrqycx .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#kyuiqrqycx .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#kyuiqrqycx .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#kyuiqrqycx .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\">\n  \n  <thead class=\"gt_col_headings\">\n    <tr>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Characteristic&lt;/strong&gt;\"><strong>Characteristic</strong></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;No Magic Hours&lt;/strong&gt;, N = 60&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>No Magic Hours</strong>, N = 60<sup class=\"gt_footnote_marks\">1</sup></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Extra Magic Hours&lt;/strong&gt;, N = 60&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>Extra Magic Hours</strong>, N = 60<sup class=\"gt_footnote_marks\">1</sup></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Overall&lt;/strong&gt;, N = 120&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>Overall</strong>, N = 120<sup class=\"gt_footnote_marks\">1</sup></th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Ticket Season</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\"></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    peak</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">18 (30%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">18 (30%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">36 (30%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    regular</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">35 (58%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">35 (58%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">70 (58%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    value</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">7 (12%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">7 (12%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">14 (12%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Close Time</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\"></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    16:30:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">1 (0.9%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">0 (0%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">1 (0.4%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    18:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">13 (21%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">18 (30%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">31 (26%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    20:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">2 (3.3%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">2 (3.3%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">4 (3.3%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    21:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">3 (4.6%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">0 (0%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">3 (2.3%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    22:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">17 (28%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">11 (18%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">28 (23%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    23:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">17 (28%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">11 (18%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">28 (23%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    24:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">8 (14%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">17 (28%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">25 (21%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    25:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">0 (0.3%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">1 (1.7%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">1 (1.0%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Historic High Temperature</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">83 (74, 88)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">83 (75, 87)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">83 (75, 88)</td></tr>\n  </tbody>\n  \n  <tfoot class=\"gt_footnotes\">\n    <tr>\n      <td class=\"gt_footnote\" colspan=\"4\"><sup class=\"gt_footnote_marks\">1</sup> n (%); Median (IQR)</td>\n    </tr>\n  </tfoot>\n</table>\n</div>\n```\n\n:::\n:::\n\n\nWe again achieve a balance between groups, but the target values in @tbl-weighted-att differ from the previous tables.\nRecall in our ATE weighted table (@tbl-weighted-gtsummary), when looking at the `wdw_ticket_season` variable, we saw the weighted percent in the peak season balanced close to 22%, the overall percent of peak days in the observed sample.\nWe again see balance, but the weighted percent of peak season days is 30% in the exposed and unexposed groups, reflecting the percent in the unweighted exposure group.\nIf you compare @tbl-weighted-att to our unweighted table (@tbl-unweighted-gtsummary), you might notice that the columns are most similar to the exposed column from the unweighted table.\nThis is because the \"target\" population is the exposed group, the days with extra magic hours in the morning, so we're trying to make the comparison group (no magic hours) as similar to that group as possible.\n\nWe can again create a mirrored histogram to observe the weighted psuedopopulation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(seven_dwarfs_wts, aes(.fitted, group = park_extra_magic_morning)) +\n  geom_mirror_histogram(bins = 50) +\n  geom_mirror_histogram(\n    aes(fill = park_extra_magic_morning, weight = w_att),\n    bins = 50,\n    alpha = 0.5\n  ) +\n  scale_y_continuous(labels = abs) +\n  labs(\n    x = \"propensity score\",\n    fill = \"Extra Magic Morning\"\n  )\n```\n\n::: {.cell-output-display}\n![A mirrored histogram of the distribution of propensity scores between exposure groups. The dark bars represent the unweighted distribution, and the colored bars represent the distribution weighted by the average treatment effect among the treated (ATT) weight.](chapter-10_files/figure-html/fig-sd-mirror-hist-att-1.png){#fig-sd-mirror-hist-att width=672}\n:::\n:::\n\n\nSince every day in the exposed group has a weight of 1, the distribution of the propensity scores (the dark bars above 0 on the graph) in @fig-sd-mirror-hist-att overlaps exactly with the weighted distribution overlaid in blue.\nIn the unexposed population, we see that almost all observations are *down weighted*; the dark orange distribution is smaller than the distribution of the propensity scores and more closely matches the exposed distribution above it.\nThe ATT is easier to estimate when there are many more observations in the unexposed group compared to the exposed one.\n\n### Average treatment effect among the unexposed\n\nThe target population to estimate the average treatment effect among the unexposed (control) (ATU / ATC) is the *unexposed* (control) population.\nThis causal estimand conditions on those in the unexposed group.\n\n$$E[Y(1) - Y(0) | X = 0]$$\n\nExample research questions where the ATU is of interest could include \"Should we send our marketing campaign to those not currently receiving it?\" or \"Should medical providers begin recommending treatment for those not currently receiving it?\" [@greifer2021choosing]\n\nThe ATU can be estimated via matching; here, all unexposed observations are included and \"matched\" to exposed observations, some of which may be discarded.\nAlternatively, the ATU can be estimated via weighting.\nThe ATU weight is estimated by:\n\n$$w_{ATU} = \\frac{X(1-p)}{p}+ (1-X)$$ Let's add the ATU weights to the `seven_dwarfs_wts` data frame and look at their distribution.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseven_dwarfs_wts <- seven_dwarfs_wts |>\n  mutate(w_atu = wt_atu(.fitted, park_extra_magic_morning))\n\nggplot(seven_dwarfs_wts, aes(w_atu)) +\n  geom_histogram(bins = 50)\n```\n\n::: {.cell-output-display}\n![A histogram of the average treatment effect among the unexposed (ATU) weights. The range of the ATU weights in this example is very similar to the ATE weights.](chapter-10_files/figure-html/fig-sd-atu-hist-1.png){#fig-sd-atu-hist width=672}\n:::\n:::\n\n\nThe distribution of the weights in @fig-sd-atu-hist weights looks very similar to what we saw with the ATE weights---several around 1, with a long tail.\nThese weights will be 1 for all observations in the unexposed group; they can range from 0 to infinity for the exposed group.\nBecause we have more observations in our unexposed group, our exposed observations are upweighted to match their distribution.\n\nNow let's take a look at the weighted table.\n\n\n::: {#tbl-weighted-atu .cell tbl-cap='A descriptive table of Extra Magic Morning hours weighted by the Average Treatment Effect among the Unexposed Weights. This table shows the distributions of these variables in the psuedopopulation created by these weights.'}\n\n```{.r .cell-code}\nseven_dwarfs_svy <- svydesign(\n  ids = ~1,\n  data = seven_dwarfs_wts,\n  weights = ~w_atu\n)\ntbl_svysummary(\n  seven_dwarfs_svy,\n  by = park_extra_magic_morning,\n  include = c(park_ticket_season, park_close, park_temperature_high)\n) |>\n  add_overall(last = TRUE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"kgmohzmjrw\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>html {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#kgmohzmjrw .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#kgmohzmjrw .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#kgmohzmjrw .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#kgmohzmjrw .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#kgmohzmjrw .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#kgmohzmjrw .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#kgmohzmjrw .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#kgmohzmjrw .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#kgmohzmjrw .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#kgmohzmjrw .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#kgmohzmjrw .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#kgmohzmjrw .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#kgmohzmjrw .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#kgmohzmjrw .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#kgmohzmjrw .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#kgmohzmjrw .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#kgmohzmjrw .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#kgmohzmjrw .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kgmohzmjrw .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#kgmohzmjrw .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#kgmohzmjrw .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kgmohzmjrw .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#kgmohzmjrw .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#kgmohzmjrw .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#kgmohzmjrw .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kgmohzmjrw .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#kgmohzmjrw .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#kgmohzmjrw .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#kgmohzmjrw .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#kgmohzmjrw .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-left: 4px;\n  padding-right: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kgmohzmjrw .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#kgmohzmjrw .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kgmohzmjrw .gt_left {\n  text-align: left;\n}\n\n#kgmohzmjrw .gt_center {\n  text-align: center;\n}\n\n#kgmohzmjrw .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#kgmohzmjrw .gt_font_normal {\n  font-weight: normal;\n}\n\n#kgmohzmjrw .gt_font_bold {\n  font-weight: bold;\n}\n\n#kgmohzmjrw .gt_font_italic {\n  font-style: italic;\n}\n\n#kgmohzmjrw .gt_super {\n  font-size: 65%;\n}\n\n#kgmohzmjrw .gt_footnote_marks {\n  font-style: italic;\n  font-weight: normal;\n  font-size: 75%;\n  vertical-align: 0.4em;\n}\n\n#kgmohzmjrw .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#kgmohzmjrw .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#kgmohzmjrw .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#kgmohzmjrw .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#kgmohzmjrw .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#kgmohzmjrw .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\">\n  \n  <thead class=\"gt_col_headings\">\n    <tr>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Characteristic&lt;/strong&gt;\"><strong>Characteristic</strong></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;No Magic Hours&lt;/strong&gt;, N = 294&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>No Magic Hours</strong>, N = 294<sup class=\"gt_footnote_marks\">1</sup></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Extra Magic Hours&lt;/strong&gt;, N = 297&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>Extra Magic Hours</strong>, N = 297<sup class=\"gt_footnote_marks\">1</sup></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Overall&lt;/strong&gt;, N = 591&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>Overall</strong>, N = 591<sup class=\"gt_footnote_marks\">1</sup></th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Ticket Season</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\"></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    peak</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">60 (20%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">63 (21%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">123 (21%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    regular</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">158 (54%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">152 (51%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">310 (52%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    value</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">76 (26%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">82 (27%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">158 (27%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Close Time</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\"></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    16:30:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">1 (0.3%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">0 (0%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">1 (0.2%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    18:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">37 (13%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">54 (18%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">91 (15%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    20:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">18 (6.1%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">17 (5.7%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">35 (5.9%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    21:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">28 (9.5%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">0 (0%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">28 (4.7%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    22:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">91 (31%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">75 (25%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">166 (28%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    23:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">78 (27%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">70 (23%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">148 (25%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    24:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">40 (14%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">77 (26%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">117 (20%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    25:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">1 (0.3%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">5 (1.6%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">6 (1.0%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Historic High Temperature</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">84 (78, 89)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">83 (78, 87)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">84 (78, 88)</td></tr>\n  </tbody>\n  \n  <tfoot class=\"gt_footnotes\">\n    <tr>\n      <td class=\"gt_footnote\" colspan=\"4\"><sup class=\"gt_footnote_marks\">1</sup> n (%); Median (IQR)</td>\n    </tr>\n  </tfoot>\n</table>\n</div>\n```\n\n:::\n:::\n\n\nNow the exposed column of @tbl-weighted-atu is weighted to match the unexposed column of the unweighted table.\n\nWe can again create a mirrored histogram to observe the weighted psuedopopulation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(seven_dwarfs_wts, aes(.fitted, group = park_extra_magic_morning)) +\n  geom_mirror_histogram(bins = 50) +\n  geom_mirror_histogram(\n    aes(fill = park_extra_magic_morning, weight = w_atu),\n    bins = 50,\n    alpha = 0.5\n  ) +\n  scale_y_continuous(labels = abs) +\n  labs(\n    x = \"propensity score\",\n    fill = \"Extra Magic Morning\"\n  )\n```\n\n::: {.cell-output-display}\n![A mirrored histogram of the distribution of propensity scores between exposure groups. The dark bars represent the unweighted distribution, and the colored bars represent the distribution weighted by the average treatment effect among the unexposed (ATU) weight.](chapter-10_files/figure-html/fig-sd-mirror-hist-atu-1.png){#fig-sd-mirror-hist-atu width=672}\n:::\n:::\n\n\nThe weights for the unexposed days are all 1, so the distribution of the propensity scores for this group exactly overlaps the weighted pseudopopulation in orange.\nThe blue bars indicate that the exposed population is largely upweighted to match the unexposed distribution.\n\n### Average treatment effect among the evenly matchable\n\nThe target population to estimate the average treatment effect among the evenly matchable (ATM) is the evenly matchable.\nThis causal estimand conditions on those deemed \"evenly matchable\" by some distance metric.\n\n$$E[Y(1) - Y(0) | M_d = 1]$$\n\nHere $d$ denotes a distance measure, and $M_d=1$ indicates that a unit is evenly matchable under that distance measure.[@samuels2017aspects; @d2018improving] Example research questions where the ATM is of interest could include \"Should those at clinical equipoise receive the exposure?\" [@greifer2021choosing]\n\nThe ATM is a common target estimand when using matching.\nHere, some exposed observations are \"matched\" to control observations, however some observations in both groups may be discarded.\nThis is often done via a \"caliper\", where observations are only matched if they fall within a pre-specified caliper distance of each other.\nAlternatively, the ATM can be estimated via weighting.\nThe ATM weight is estimated by:\n\n$$w_{ATM} = \\frac{\\min \\{p, 1-p\\}}{Xp + (1-X)(1-p)}$$\n\nLet's add the ATM weights to the `seven_dwarfs_wts` data frame and look at their distribution.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseven_dwarfs_wts <- seven_dwarfs_wts |>\n  mutate(w_atm = wt_atm(.fitted, park_extra_magic_morning))\n\nggplot(seven_dwarfs_wts, aes(w_atm)) +\n  geom_histogram(bins = 50)\n```\n\n::: {.cell-output-display}\n![A histogram of the average treatment effect among the evenly matchable (ATM) weights for whether or not a day had extra magic hours. ATM weights can range from 0 to 1, so they are always stable.](chapter-10_files/figure-html/fig-sd-atm-hist-1.png){#fig-sd-atm-hist width=672}\n:::\n:::\n\n\nThe distribution of the weights in @fig-sd-atm-hist looks very similar to what we saw with the ATT weights.\nThat is because, in this particular sample, there are many more unexposed observations compared to exposed ones.\nThese weights have the nice property that they range from 0 to 1, making them *always* stable, regardless of the imbalance between exposure groups.\n\nNow let's take a look at the weighted table.\n\n\n::: {#tbl-weighted-atm .cell tbl-cap='A descriptive table of Extra Magic Morning hours weighted by the Average Treatment Effect among the Evenly Matchable Weights. This table shows the distributions of these variables in the psuedopopulation created by these weights.'}\n\n```{.r .cell-code}\nseven_dwarfs_svy <- svydesign(\n  ids = ~1,\n  data = seven_dwarfs_wts,\n  weights = ~w_atm\n)\ntbl_svysummary(\n  seven_dwarfs_svy,\n  by = park_extra_magic_morning,\n  include = c(park_ticket_season, park_close, park_temperature_high)\n) |>\n  add_overall(last = TRUE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"mduhivknhv\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>html {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#mduhivknhv .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#mduhivknhv .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#mduhivknhv .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#mduhivknhv .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#mduhivknhv .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#mduhivknhv .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#mduhivknhv .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#mduhivknhv .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#mduhivknhv .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#mduhivknhv .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#mduhivknhv .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#mduhivknhv .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#mduhivknhv .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#mduhivknhv .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#mduhivknhv .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#mduhivknhv .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#mduhivknhv .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#mduhivknhv .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#mduhivknhv .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#mduhivknhv .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#mduhivknhv .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#mduhivknhv .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#mduhivknhv .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#mduhivknhv .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#mduhivknhv .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#mduhivknhv .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#mduhivknhv .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#mduhivknhv .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#mduhivknhv .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#mduhivknhv .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-left: 4px;\n  padding-right: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#mduhivknhv .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#mduhivknhv .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#mduhivknhv .gt_left {\n  text-align: left;\n}\n\n#mduhivknhv .gt_center {\n  text-align: center;\n}\n\n#mduhivknhv .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#mduhivknhv .gt_font_normal {\n  font-weight: normal;\n}\n\n#mduhivknhv .gt_font_bold {\n  font-weight: bold;\n}\n\n#mduhivknhv .gt_font_italic {\n  font-style: italic;\n}\n\n#mduhivknhv .gt_super {\n  font-size: 65%;\n}\n\n#mduhivknhv .gt_footnote_marks {\n  font-style: italic;\n  font-weight: normal;\n  font-size: 75%;\n  vertical-align: 0.4em;\n}\n\n#mduhivknhv .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#mduhivknhv .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#mduhivknhv .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#mduhivknhv .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#mduhivknhv .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#mduhivknhv .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\">\n  \n  <thead class=\"gt_col_headings\">\n    <tr>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Characteristic&lt;/strong&gt;\"><strong>Characteristic</strong></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;No Magic Hours&lt;/strong&gt;, N = 60&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>No Magic Hours</strong>, N = 60<sup class=\"gt_footnote_marks\">1</sup></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Extra Magic Hours&lt;/strong&gt;, N = 60&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>Extra Magic Hours</strong>, N = 60<sup class=\"gt_footnote_marks\">1</sup></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Overall&lt;/strong&gt;, N = 120&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>Overall</strong>, N = 120<sup class=\"gt_footnote_marks\">1</sup></th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Ticket Season</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\"></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    peak</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">18 (30%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">18 (30%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">36 (30%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    regular</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">35 (58%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">35 (58%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">70 (58%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    value</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">7 (12%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">7 (12%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">14 (12%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Close Time</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\"></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    16:30:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">1 (0.9%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">0 (0%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">1 (0.4%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    18:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">13 (21%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">18 (30%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">31 (26%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    20:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">2 (3.3%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">2 (3.3%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">4 (3.3%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    21:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">3 (4.6%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">0 (0%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">3 (2.3%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    22:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">17 (28%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">11 (18%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">28 (23%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    23:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">17 (28%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">11 (18%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">28 (23%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    24:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">8 (14%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">17 (28%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">25 (21%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    25:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">0 (0.3%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">1 (1.7%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">1 (1.0%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Historic High Temperature</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">83 (74, 88)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">83 (75, 87)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">83 (75, 88)</td></tr>\n  </tbody>\n  \n  <tfoot class=\"gt_footnotes\">\n    <tr>\n      <td class=\"gt_footnote\" colspan=\"4\"><sup class=\"gt_footnote_marks\">1</sup> n (%); Median (IQR)</td>\n    </tr>\n  </tfoot>\n</table>\n</div>\n```\n\n:::\n:::\n\n\nIn this particular sample, the ATM weights resemble the ATT weights, so this table looks similar to the ATT weighted table.\nThis similarity is not guaranteed, and the ATM pseudopopulation can look different from the overall, exposed, and unexposed unweighted populations.\nIt's thus essential to examine the weighted table when using ATM weights to understand what population inference will ultimately be drawn on.\n\nWe can again create a mirrored histogram to observe the ATM weighted psuedopopulation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(seven_dwarfs_wts, aes(.fitted, group = park_extra_magic_morning)) +\n  geom_mirror_histogram(bins = 50) +\n  geom_mirror_histogram(\n    aes(fill = park_extra_magic_morning, weight = w_atm),\n    bins = 50,\n    alpha = 0.5\n  ) +\n  scale_y_continuous(labels = abs) +\n  labs(\n    x = \"propensity score\",\n    fill = \"Extra Magic Morning\"\n  )\n```\n\n::: {.cell-output-display}\n![A mirrored histogram of the distribution of propensity scores between exposure groups. The dark bars represent the unweighted distribution, and the colored bars represent the distribution weighted by the average treatment effect among the evenly matchable (ATM) weight.](chapter-10_files/figure-html/fig-sd-mirror-hist-atm-1.png){#fig-sd-mirror-hist-atm width=672}\n:::\n:::\n\n\nAgain, the ATM weights are bounded by 0 and 1, meaning that all observations will be *down weighted*.\nThis removes the potential for finite sample bias due to large weights in small samples and has improved variance properties.\n\n### Average treatment effect among the overlap population\n\nThe target population to estimate the average treatment effect among the overlap population (ATO) is the overlap -- this is very similar to the \"even matchable\" from above.\nExample research questions where the ATO is of interest are the same as those for the ATM, such as \"Should those at clinical equipoise receive the exposure?\" [@greifer2021choosing]\n\nThese weights, again, are pretty similar to the ATM weights but are slightly attenuated, yielding improved variance properties.\n\nThe ATO weight is estimated by:\n\n$$w_{ATO} = X(1-p) + (1-X)p$$\n\nLet's add the ATO weights to the `seven_dwarfs_wts` data frame and look at their distribution.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseven_dwarfs_wts <- seven_dwarfs_wts |>\n  mutate(w_ato = wt_ato(.fitted, park_extra_magic_morning))\n\nggplot(seven_dwarfs_wts, aes(w_ato)) +\n  geom_histogram(bins = 50)\n```\n\n::: {.cell-output-display}\n![A histogram of the average treatment effect among the overlap population (ATO) weights for whether or not a day had extra magic hours. Like ATM weights, ATO weights can range from 0 to 1, so they are always stable. ATO weights also have improved variance properties compared to the ATM weights.](chapter-10_files/figure-html/fig-sd-ato-hist-1.png){#fig-sd-ato-hist width=672}\n:::\n:::\n\n\nLike the ATM weights, the ATO weights are bounded by 0 and 1, making them more stable than the ATE, ATT, and ATU, regardless of the exposed and unexposed imbalance.\n\n::: {.callout-warning}\n## Finite sample bias - revisited\n\nLet's revisit our finite sample bias simulation, adding in the ATO weights to examine whether they are impacted by this potential for bias.\n\n\n::: {.cell hash='chapter-10_cache/html/sim-finite-sample-bias-2_4e1800bf54b6b2874f4e046f933337ae'}\n\n```{.r .cell-code}\nsim <- function(n) {\n  ## create a simulated dataset\n  finite_sample <- tibble(\n    z = rnorm(n),\n    x = case_when(\n      0.5 + z + rnorm(n) > 0 ~ 1,\n      TRUE ~ 0\n    ),\n    y = z + rnorm(n)\n  )\n  finite_sample_wts <- glm(\n    x ~ z, data = finite_sample, family = binomial(\"probit\")) |>\n    augment(newdata = finite_sample, type.predict = \"response\") |>\n    mutate(wts_ate = wt_ate(.fitted, x),\n           wts_ato = wt_ato(.fitted, x))\n  bias <- finite_sample_wts |>\n    summarize(\n      effect_ate = sum(y * x * wts_ate) / sum(x * wts_ate) - \n        sum(y * (1 - x) * wts_ate) / sum((1 - x) * wts_ate),\n      effect_ato = sum(y * x * wts_ato) / sum(x * wts_ato) - \n        sum(y * (1 - x) * wts_ato) / sum((1 - x) * wts_ato)\n    )\n  tibble(\n    n = n,\n    bias = c(bias$effect_ate, bias$effect_ato),\n    weight = c(\"ATE\", \"ATO\")\n  )\n}\n\n## Examine 5 different sample sizes, simulate each 1000 times\nset.seed(1)\nfinite_sample_sims <- map_df(rep(c(50, 100, 500, 1000, 5000, 10000), \n                                 each = 1000), sim)\n\nbias <- finite_sample_sims %>%\n  group_by(n, weight) %>%\n  summarise(bias = mean(bias))\n```\n:::\n\n\nLet's plot our results:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(bias, aes(x = n, y = bias, color = weight)) +\n  geom_point() + \n  geom_line() + \n  geom_hline(yintercept = 0, lty = 2)\n```\n\n::: {.cell-output-display}\n![Finite sample bias with ATE weights (orange) and ATO weights (blue) created using correctly specified propensity score model, varying the sample size from n = 50 to n = 10,000](chapter-10_files/figure-html/fig-finite-sample-bias-2-1.png){#fig-finite-sample-bias-2 width=672}\n:::\n:::\n\n\nNotice here the estimate using the ATO weights is almost immediately unbiased, even in fairly small samples.\n:::\n\nNow let's take a look at the weighted table.\n\n\n::: {#tbl-weighted-ato .cell tbl-cap='A descriptive table of Extra Magic Morning hours weighted by the Average Treatment Effect among the Overlap Population Weights. This table shows the distributions of these variables in the psuedopopulation created by these weights.'}\n\n```{.r .cell-code}\nseven_dwarfs_svy <- svydesign(\n  ids = ~1,\n  data = seven_dwarfs_wts,\n  weights = ~w_ato\n)\ntbl_svysummary(\n  seven_dwarfs_svy,\n  by = park_extra_magic_morning,\n  include = c(park_ticket_season, park_close, park_temperature_high)\n) |>\n  add_overall(last = TRUE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"uaaskkmbew\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>html {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#uaaskkmbew .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#uaaskkmbew .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#uaaskkmbew .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#uaaskkmbew .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#uaaskkmbew .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#uaaskkmbew .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#uaaskkmbew .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#uaaskkmbew .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#uaaskkmbew .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#uaaskkmbew .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#uaaskkmbew .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#uaaskkmbew .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#uaaskkmbew .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#uaaskkmbew .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#uaaskkmbew .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#uaaskkmbew .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#uaaskkmbew .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#uaaskkmbew .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#uaaskkmbew .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#uaaskkmbew .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#uaaskkmbew .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-left: 4px;\n  padding-right: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#uaaskkmbew .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#uaaskkmbew .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#uaaskkmbew .gt_left {\n  text-align: left;\n}\n\n#uaaskkmbew .gt_center {\n  text-align: center;\n}\n\n#uaaskkmbew .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#uaaskkmbew .gt_font_normal {\n  font-weight: normal;\n}\n\n#uaaskkmbew .gt_font_bold {\n  font-weight: bold;\n}\n\n#uaaskkmbew .gt_font_italic {\n  font-style: italic;\n}\n\n#uaaskkmbew .gt_super {\n  font-size: 65%;\n}\n\n#uaaskkmbew .gt_footnote_marks {\n  font-style: italic;\n  font-weight: normal;\n  font-size: 75%;\n  vertical-align: 0.4em;\n}\n\n#uaaskkmbew .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#uaaskkmbew .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#uaaskkmbew .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#uaaskkmbew .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#uaaskkmbew .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#uaaskkmbew .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\">\n  \n  <thead class=\"gt_col_headings\">\n    <tr>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Characteristic&lt;/strong&gt;\"><strong>Characteristic</strong></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;No Magic Hours&lt;/strong&gt;, N = 48&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>No Magic Hours</strong>, N = 48<sup class=\"gt_footnote_marks\">1</sup></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Extra Magic Hours&lt;/strong&gt;, N = 48&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>Extra Magic Hours</strong>, N = 48<sup class=\"gt_footnote_marks\">1</sup></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Overall&lt;/strong&gt;, N = 96&lt;sup class=&quot;gt_footnote_marks&quot;&gt;1&lt;/sup&gt;\"><strong>Overall</strong>, N = 96<sup class=\"gt_footnote_marks\">1</sup></th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Ticket Season</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\"></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    peak</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">14 (29%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">14 (29%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">28 (29%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    regular</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">28 (58%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">28 (58%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">55 (58%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    value</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">6 (13%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">6 (13%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">13 (13%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Close Time</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\"></td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\"></td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    16:30:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">0 (0.7%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">0 (0%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">0 (0.4%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    18:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">9 (19%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">13 (27%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">22 (23%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    20:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">2 (3.7%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">2 (3.7%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">4 (3.7%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    21:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">2 (5.1%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">0 (0%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">2 (2.5%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    22:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">14 (29%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">9 (20%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">23 (24%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    23:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">14 (28%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">9 (19%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">23 (24%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    24:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">7 (14%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">14 (29%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">21 (22%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">    25:00:00</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">0 (0.3%)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">1 (1.7%)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">1 (1.0%)</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">Historic High Temperature</td>\n<td headers=\"stat_1\" class=\"gt_row gt_center\">83 (75, 88)</td>\n<td headers=\"stat_2\" class=\"gt_row gt_center\">83 (76, 87)</td>\n<td headers=\"stat_0\" class=\"gt_row gt_center\">83 (75, 88)</td></tr>\n  </tbody>\n  \n  <tfoot class=\"gt_footnotes\">\n    <tr>\n      <td class=\"gt_footnote\" colspan=\"4\"><sup class=\"gt_footnote_marks\">1</sup> n (%); Median (IQR)</td>\n    </tr>\n  </tfoot>\n</table>\n</div>\n```\n\n:::\n:::\n\n\nLike the ATM weights, the ATO pseudopopulation may not resemble the overall, exposed, or unexposed unweighted populations, so it is essential to examine these weighted tables to understand the population on whom we will draw inferences.\n\nWe can again create a mirrored histogram to observe the ATO weighted psuedopopulation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(seven_dwarfs_wts, aes(.fitted, group = park_extra_magic_morning)) +\n  geom_mirror_histogram(bins = 50) +\n  geom_mirror_histogram(\n    aes(fill = park_extra_magic_morning, weight = w_ato),\n    bins = 50,\n    alpha = 0.5\n  ) +\n  scale_y_continuous(labels = abs) +\n  labs(\n    x = \"propensity score\",\n    fill = \"Extra Magic Morning\"\n  )\n```\n\n::: {.cell-output-display}\n![A mirrored histogram of the distribution of propensity scores between exposure groups. The dark bars represent the unweighted distribution, and the colored bars represent the distribution weighted by the average treatment effect among the overlap population (ATO) weight.](chapter-10_files/figure-html/fig-sd-mirror-hist-ato-1.png){#fig-sd-mirror-hist-ato width=672}\n:::\n:::\n\n\n@fig-sd-mirror-hist-ato looks similar to the ATM pseudopopulation, with slight attenuation, as evidenced by the increased down weighting in the exposed population.\nWe prefer using the ATO weights when the overlap (or evenly matchable) population is the target, as they have improved variance properties.\nAnother benefit is that any variables included in the propensity score model (if fit via logistic regression) will be perfectly balanced on the mean.\nWe will discuss this further in @sec-eval-ps-model.\n\n## Choosing estimands\n\nSeveral factors need to be considered when choosing an estimand for a given analysis.\nFirst an foremost, the research question at hand will drive this decision.\nFor example, returing to the Touring Plans data, suppose Disney was interested in assessing whether they should add additional extra magic hours on days that don't currently have them---here, the ATU will be the estimand of interest.\nOther considerations include the available sample size and the distribution of the exposed and unexposed observations (i.e. might finite sample bias be an issue?).\nBelow is a table summarizing the estimands and methods for estimating them (including R functions and example code), along with sample questions extended from Table 2 in @greifer2021choosing.\n\n+----------+----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------+------------------------+\n| Estimand | Target population                | Example Research Question                                                                                                                                  | Matching Method                               | Weighting Method       |\n+==========+==================================+============================================================================================================================================================+===============================================+========================+\n| ATE      | Full population                  | Should we decide whether to have extra magic hours *all* mornings to change the wait time for Seven Dwarfs Mine Train between 5-6pm?                       | Full matching                                 | ATE Weights            |\n|          |                                  |                                                                                                                                                            |                                               |                        |\n|          |                                  | Should a specific policy be applied to all eligible observations?                                                                                          | Fine stratification                           | `propensity::wt_ate()` |\n|          |                                  |                                                                                                                                                            |                                               |                        |\n|          |                                  |                                                                                                                                                            | `MatchIt::matchit(…, estimand = \"ATE\")`       | |                      |\n+----------+----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------+------------------------+\n| ATT      | Exposed (treated) observations   | Should we stop extra magic hours to change the wait time for Seven Dwarfs Mine Train between 5-6pm?                                                        | Pair matching without a caliper               | ATT weights            |\n|          |                                  |                                                                                                                                                            |                                               |                        |\n|          |                                  | Should we stop our marketing campaign to those currently receiving it?                                                                                     | Full matching                                 | `propensity::wt_att()` |\n|          |                                  |                                                                                                                                                            |                                               |                        |\n|          |                                  | Should medical providers stop recommending treatment for those currently receiving it?                                                                     | Fine stratification                           |                        |\n|          |                                  |                                                                                                                                                            |                                               |                        |\n|          |                                  |                                                                                                                                                            | `MatchIt::matchit(…, estimand = \"ATT\")`       |                        |\n+----------+----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------+------------------------+\n| ATU      | Unexposed (control) observations | Should we add extra magic hours for all days to change the wait time for Seven Dwarfs Mine Train between 5-6pm?                                            | Pair matching without a caliper               | ATU weights            |\n|          |                                  |                                                                                                                                                            |                                               |                        |\n|          |                                  | Should we extend our marketing campaign to those not receiving it?                                                                                         | Full matching                                 | `propensity::wt_atu()` |\n|          |                                  |                                                                                                                                                            |                                               |                        |\n|          |                                  | Should medical providers extend treatment to those not currently receiving it?                                                                             | Fine stratification                           |                        |\n|          |                                  |                                                                                                                                                            |                                               |                        |\n|          |                                  |                                                                                                                                                            | `MatchIt::matchit(…, estimand = \"ATC\")`       |                        |\n+----------+----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------+------------------------+\n| ATM      | Evenly matchable                 | Are there some days we should change whether we are offering extra magic hours in order to change the wait time for Seven Dwarfs Mine Train between 5-6pm? | Caliper matching                              | ATM weights            |\n|          |                                  |                                                                                                                                                            |                                               |                        |\n|          |                                  | Is there an effect of the exposure for some observations?                                                                                                  | `MatchIt::matchit(…, caliper = 0.1)`          | `propensity::wt_atm()` |\n|          |                                  |                                                                                                                                                            |                                               |                        |\n|          |                                  | Should those at clinical equipoise receive treatment?                                                                                                      | Coarsened exact matching                      |                        |\n|          |                                  |                                                                                                                                                            |                                               |                        |\n|          |                                  |                                                                                                                                                            | Cardinality matching                          |                        |\n|          |                                  |                                                                                                                                                            |                                               |                        |\n|          |                                  |                                                                                                                                                            | `MatchIt::matchit(…, method = \"cardinality\")` |                        |\n+----------+----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------+------------------------+\n| ATO      | Overlap population               | Same as ATM                                                                                                                                                |                                               | ATO weights            |\n|          |                                  |                                                                                                                                                            |                                               |                        |\n|          |                                  |                                                                                                                                                            |                                               | `propensity::wt_ato()` |\n+----------+----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------+------------------------+\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}